import React, { useState, useEffect, useRef } from 'react';

const sampleTexts = [
  "The quick brown fox jumps over the lazy dog near the riverbank where children play and birds sing their morning songs under the bright blue sky.",
  "Technology has revolutionized the way we communicate and interact with each other in modern society bringing people closer despite physical distances.",
  "Practice makes perfect when learning new skills and developing expertise in any field requires dedication patience and consistent effort over time.",
  "Mountains rise majestically above the clouds while valleys stretch endlessly below creating breathtaking landscapes that inspire wonder and admiration.",
  "Music has the power to evoke emotions and memories transporting us to different times and places with just a simple melody or harmony."
];

export default function TypingSpeedTest() {
  const [text, setText] = useState('');
  const [input, setInput] = useState('');
  const [started, setStarted] = useState(false);
  const [finished, setFinished] = useState(false);
  const [startTime, setStartTime] = useState(null);
  const [timeLimit, setTimeLimit] = useState(30);
  const [timeRemaining, setTimeRemaining] = useState(30);
  const [wpm, setWpm] = useState(0);
  const [accuracy, setAccuracy] = useState(100);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [errors, setErrors] = useState(0);
  const inputRef = useRef(null);
  const cursorRef = useRef(null);

  useEffect(() => {
    resetTest();
  }, []);

  useEffect(() => {
    let interval;
    if (started && !finished && timeRemaining > 0) {
      interval = setInterval(() => {
        setTimeRemaining(prev => {
          if (prev <= 1) {
            setFinished(true);
            calculateFinalWPM();
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [started, finished, timeRemaining]);

  useEffect(() => {
    // Smooth cursor position update
    if (cursorRef.current) {
      const textElement = document.getElementById('text-display');
      const chars = textElement?.getElementsByClassName('char');
      if (chars && chars[currentIndex]) {
        const rect = chars[currentIndex].getBoundingClientRect();
        const containerRect = textElement.getBoundingClientRect();
        cursorRef.current.style.transform = `translate(${rect.left - containerRect.left}px, ${rect.top - containerRect.top}px)`;
      }
    }
  }, [currentIndex]);

  const resetTest = () => {
    const randomText = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
    setText(randomText);
    setInput('');
    setStarted(false);
    setFinished(false);
    setStartTime(null);
    setTimeRemaining(timeLimit);
    setWpm(0);
    setAccuracy(100);
    setCurrentIndex(0);
    setErrors(0);
    if (inputRef.current) inputRef.current.focus();
  };

  const handleInputChange = (e) => {
    const value = e.target.value;
    
    if (!started) {
      setStarted(true);
      setStartTime(Date.now());
    }

    if (finished) return;

    setInput(value);
    setCurrentIndex(value.length);

    // Count errors
    let errorCount = 0;
    for (let i = 0; i < value.length; i++) {
      if (value[i] !== text[i]) errorCount++;
    }
    setErrors(errorCount);

    // Calculate accuracy
    const acc = value.length > 0 ? ((value.length - errorCount) / value.length) * 100 : 100;
    setAccuracy(Math.round(acc));

    // Calculate WPM
    if (started) {
      calculateWPM(value);
    }
  };

  const calculateWPM = (typedText) => {
    const timeElapsed = (Date.now() - startTime) / 1000 / 60; // in minutes
    const wordsTyped = typedText.trim().split(/\s+/).filter(w => w.length > 0).length;
    const calculatedWpm = Math.round(wordsTyped / timeElapsed);
    setWpm(calculatedWpm || 0);
  };

  const calculateFinalWPM = () => {
    const timeElapsed = timeLimit / 60; // in minutes
    const wordsTyped = input.trim().split(/\s+/).filter(w => w.length > 0).length;
    const calculatedWpm = Math.round(wordsTyped / timeElapsed);
    setWpm(calculatedWpm || 0);
  };

  const getCharClass = (index) => {
    if (index < currentIndex) {
      return input[index] === text[index] ? 'text-green-400' : 'text-red-400 bg-red-900/30';
    }
    return 'text-gray-500';
  };

  const changeTimeLimit = (seconds) => {
    setTimeLimit(seconds);
    setTimeRemaining(seconds);
    resetTest();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex flex-col items-center justify-center p-4">
      <div className="max-w-4xl w-full">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-5xl font-bold text-yellow-400 mb-2">TypeTest</h1>
          <p className="text-gray-400">Test your typing speed and accuracy</p>
        </div>

        {/* Time Selector */}
        <div className="flex justify-center gap-4 mb-6">
          <button
            onClick={() => changeTimeLimit(15)}
            className={`px-6 py-2 rounded-lg font-semibold transition-all ${
              timeLimit === 15
                ? 'bg-yellow-400 text-gray-900'
                : 'bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-700'
            }`}
          >
            15s
          </button>
          <button
            onClick={() => changeTimeLimit(30)}
            className={`px-6 py-2 rounded-lg font-semibold transition-all ${
              timeLimit === 30
                ? 'bg-yellow-400 text-gray-900'
                : 'bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-700'
            }`}
          >
            30s
          </button>
          <button
            onClick={() => changeTimeLimit(60)}
            className={`px-6 py-2 rounded-lg font-semibold transition-all ${
              timeLimit === 60
                ? 'bg-yellow-400 text-gray-900'
                : 'bg-gray-800 text-gray-400 hover:bg-gray-700 border border-gray-700'
            }`}
          >
            60s
          </button>
        </div>

        {/* Stats Display */}
        {started && (
          <div className="grid grid-cols-4 gap-4 mb-6">
            <div className="bg-gray-800 rounded-lg p-4 text-center border border-gray-700">
              <div className="text-3xl font-bold text-yellow-400">{timeRemaining}s</div>
              <div className="text-sm text-gray-400 uppercase">Time</div>
            </div>
            <div className="bg-gray-800 rounded-lg p-4 text-center border border-gray-700">
              <div className="text-3xl font-bold text-blue-400">{wpm}</div>
              <div className="text-sm text-gray-400 uppercase">WPM</div>
            </div>
            <div className="bg-gray-800 rounded-lg p-4 text-center border border-gray-700">
              <div className="text-3xl font-bold text-green-400">{accuracy}%</div>
              <div className="text-sm text-gray-400 uppercase">Accuracy</div>
            </div>
            <div className="bg-gray-800 rounded-lg p-4 text-center border border-gray-700">
              <div className="text-3xl font-bold text-purple-400">{errors}</div>
              <div className="text-sm text-gray-400 uppercase">Errors</div>
            </div>
          </div>
        )}

        {/* Text Display with Cursor */}
        <div className="bg-gray-800 rounded-lg p-8 mb-6 border border-gray-700 shadow-2xl relative">
          <div id="text-display" className="text-2xl leading-relaxed font-mono tracking-wide relative">
            {/* Animated Cursor */}
            <div
              ref={cursorRef}
              className="absolute w-0.5 h-8 bg-yellow-400 animate-pulse transition-transform duration-100 ease-out"
              style={{ transformOrigin: 'top left' }}
            />
            {text.split('').map((char, index) => (
              <span key={index} className={`char ${getCharClass(index)} transition-colors duration-100`}>
                {char}
              </span>
            ))}
          </div>
        </div>

        {/* Input Area */}
        <div className="mb-6">
          <input
            ref={inputRef}
            type="text"
            value={input}
            onChange={handleInputChange}
            disabled={finished}
            className="w-full bg-gray-800 text-white text-xl p-4 rounded-lg border-2 border-gray-700 focus:border-yellow-400 focus:outline-none font-mono disabled:opacity-50"
            placeholder={finished ? "Test completed!" : "Start typing here..."}
            autoFocus
          />
        </div>

        {/* Results */}
        {finished && (
          <div className="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg p-6 mb-6 text-center">
            <h2 className="text-3xl font-bold text-gray-900 mb-2">Test Complete! ðŸŽ‰</h2>
            <div className="flex justify-center gap-8 text-gray-900 text-lg font-semibold">
              <div>WPM: {wpm}</div>
              <div>Accuracy: {accuracy}%</div>
              <div>Errors: {errors}</div>
            </div>
          </div>
        )}

        {/* Reset Button */}
        <button
          onClick={resetTest}
          className="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold text-lg py-4 rounded-lg transition-colors duration-200 shadow-lg"
        >
          {finished ? 'Try Again' : 'Reset Test'}
        </button>

        {/* Instructions */}
        <div className="mt-8 text-center text-gray-500 text-sm">
          <p>Select a time limit and start typing to begin the test</p>
          <p className="mt-2">Your typing speed (WPM) and accuracy will be calculated in real-time</p>
        </div>
      </div>
    </div>
  );
}